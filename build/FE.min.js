!function(){function t(t,e,n,o){t=e.setContextStyle(t);t.fillText(e.char,n,o)}function e(t,e){this.char=t,this.style=e||Object.create(i.text)}function n(t,n){this.ctx=t;var o=this.MCS=[];n=n?String(n):"";for(var i,r=0,a=[],s=0;i=n[r];r+=1)if("\n"===i){o.push(a);s+=1;a=[]}else a.push(new e(i));o.push(a);this.draw()}function o(){canvasNode=document.querySelector("canvas.editor");canvasNode.width=i.editor.width;canvasNode.height=i.editor.height;ctx=canvasNode.getContext("2d");var t=new n(ctx,"asdadsadsdas\n萨达大厦的asdasd阿"),e=new WeakMap,o=new WeakMap;canvasNode.addEventListener("click",function(n){function i(e){var n=t.getOffset(e.line,e.column);r.style.left=n.x+canvasNode.offsetLeft+"px";r.style.top=n.y+canvasNode.offsetTop+"px"}var r=e.get(canvasNode);if(!r){r=document.createElement("input");r.className="cursor";r.addEventListener("input",function(){var e=o.get(this);t.add(this.value,e.line,e.column);e.column+=this.value.length;t.draw();i(e);this.value=""});r.addEventListener("keydown",function(e){var n=o.get(this);switch(e.which){case 13:var r=t.newLine(n.line,n.column);t.draw();n.line=r.line;n.column=r.column;i(n)}});e.set(canvasNode,r);document.body.appendChild(r)}var a=t.getNearCInfo(n.offsetX,n.offsetY);o.set(r,a);i(a);r.focus()})}var i={editor:{height:400,width:400},text:{font_size:"14px",font_family:"思源黑体 CN Regular",color:"#222222"},d_text:{font_size:"12px",font_family:"Source Code Pro",color:"#000000"}};e.ctx=function(){return document.createElement("canvas").getContext("2d")}();e.prototype={getFontSize:function(){this.style;return this.style.font_size||i.text.font_size||i.d_text.font_size},getFontFamily:function(){return this.style.font_family||i.text.font_family||i.d_text.font_family},getFontString:function(){return this.getFontSize()+" "+this.getFontFamily()},getColor:function(){return this.style.color||i.text.color||i.d_text.color},getHeight:function(){return parseFloat(this.getFontSize())||12},setContextStyle:function(t){t.font=this.getFontString();t.textAlign="left";t.fillStyle=this.getColor();return t},getWidth:function(){var t=this.setContextStyle(e.ctx);return t.measureText(this.char).width}};var r={getLineHeight:function(t){for(var e,n=0,o=0;e=t[o];o+=1){var i=e.getHeight();i>n&&(n=i)}return n}};n.prototype={getNearCInfo:function(t,e){for(var n,o=this.MCS,i=0,a=0,s=0,c=0,l=o.length;l>c;c+=1){n=o[c];s=c;if(e>=i&&(i+=a=r.getLineHeight(n))>=e)break}var f=0,h=0,u=0;console.group(t);console.log(n);for(var d,c=0,l=n.length;l>c;c+=1){d=n[c];u=c;var g=f-h/2;h=d.getWidth();var v=f+h/2;f+=h;console.log(g,t,v);if(t>=g&&v>=t)break}console.log(c,l,u);c&&c===l&&(u+=1);console.groupEnd(t);return{C:d,x:f-h,y:i-a,line:s,column:u}},draw:function(){ctx=this.ctx;ctx.fillStyle="#FFFFFF";var e=ctx.canvas;ctx.fillRect(0,0,e.width,e.height);for(var n,o,i,a,s=this.MCS,c=0,l=0;a=s[l];l+=1){n=r.getLineHeight(a);c+=n;o=0;for(var f,h=0;f=a[h];h+=1){i=f.getWidth();t(ctx,f,o,c);o+=i}}},add:function(t,n,o){var i=this.MCS;t=t?String(t):"";if(t)for(var r,a=t.length-1;r=t[a];a-=1){var s=i[n];s||(s=i[n]=[]);var c=new e(r);s.splice(o,0,c)}},getOffset:function(t,e){for(var n,o,i=this.MCS,a=0,s=0,c=0,l=0,f=0;t>=f;f+=1){n=i[f];a+=s=r.getLineHeight(n)}for(var f=0;e>f;f+=1){o=n[f];c+=l=o.getWidth()}return{x:c,y:a-s}},newLine:function(t,e){var n=this.MCS,o=n[t],i=o.splice(e);this.MCS.splice(t+1,0,i);return{line:t+1,column:0}}};window.onload=o}();